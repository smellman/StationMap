<html>
  <head>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="https://rmap.ekispert.jp/production/rosen.css" />
    <script src="https://rmap.ekispert.jp/production/rosen.js"></script>
    <style>
    body {
      margin: 0;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    </style>
  </head>
  <div id="map"></div>
  <script>
  var rosen

  // 1: initの引数にapi_keyを渡すようにする
  function init(api_key) {
    rosen = new Rosen("map", {
      apiKey: api_key,
    })
  }

  // 2: messsage EventをハンドルすることでpostMessageで渡されたデータを処理をすることを可能に
  document.addEventListener('message', (event) => {
    if (event && event.data) {
      try {
        // 3: postMessageで渡されるのは文字列型なので、JSON.parseで復元する
        data = JSON.parse(event.data)
        // 4: data.typeが init_mapの場合は初期化の処理を行う
        if (data.type == "init_map") {
          init(data.api_key)
        }
      } catch (e) {
        console.log(e)
      }
    }
  })
  </script>
</html>
